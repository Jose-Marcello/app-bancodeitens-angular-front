steps:
  - uses: actions/checkout@v3 
    with:
      submodules: true
      lfs: false

  # 1. SETUP DO NODE.JS: Garante que o ambiente tenha o Node/NPM para o build do Angular
  - name: Setup Node.js
    uses: actions/setup-node@v3
    with:
      node-version: '20' # Vers�o est�vel do Node.js

  # 2. INSTALA��O E BUILD DO FRONTEND ANGULAR
  - name: Install Dependencies and Build Angular App
    # Assume que o package.json do Angular est� na raiz do reposit�rio (app_location: "/")
    run: |
      npm install
      # Executa o build. O --output-path DEVE BATER com o output_location abaixo
      npm run build -- --output-path=dist/banco-de-itens-app --configuration=production

  # 3. DEPLOY PARA O AZURE STATIC WEB APPS
  - name: Build And Deploy
    id: builddeploy
    uses: Azure/static-web-apps-deploy@v1
    with:
      # TOKEN DEPLOY: Usa o segredo que criamos/validamos no GitHub.
      # ISSO FINALMENTE DEVE RESOLVER O ERRO DE AUTENTICA��O.
      azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BDEITENS_QA }}
      action: "upload"
      
      # Caminhos de localiza��o do SWA
      app_location: "/" # Raiz do reposit�rio (onde est� o package.json)
      api_location: "" # API separada, sem build aqui
      output_location: "dist/banco-de-itens-app" # Caminho de sa�da do ng build


close_pull_request_job:
if: github.event_name == 'pull_request' && github.event.action == 'closed'
runs-on: ubuntu-latest
name: Close Pull Request Job
permissions:
contents: read

steps:
  - name: Close Pull Request
    id: closepullrequest
    uses: Azure/static-web-apps-deploy@v1
    with:
      action: "close"
      # Usa o mesmo segredo para fechar a URL de staging
      azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BDEITENS_QA }}
